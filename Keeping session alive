# Check if libstdc++.so.6 exists in your conda env
ls -la /data/1/gcganamrswp/data/is44065/data/py39/lib/libstdc++.so*

# Check what GLIBCXX versions it has
strings /data/1/gcganamrswp/data/is44065/data/py39/lib/libstdc++.so.6 | grep GLIBCXX

export LD_LIBRARY_PATH=/data/1/gcganamrswp/data/is44065/data/modele_env_py39/lib:$LD_LIBRARY_PATH
/data/1/gcganamrswp/data/is44065/data/modele_env_py39/bin/python3 -c "import shap; print('Success!')"

pyspark3 \
  --conf spark.executorEnv.LD_LIBRARY_PATH=/data/1/gcganamrswp/data/is44065/data/modele_env_py39/lib \
  --conf spark.yarn.appMasterEnv.LD_LIBRARY_PATH=/data/1/gcganamrswp/data/is44065/data/modele_env_py39/lib \
  --conf spark.driverEnv.LD_LIBRARY_PATH=/data/1/gcganamrswp/data/is44065/data/modele_env_py39/lib \
  --conf spark.port.maxRetries=50 \
  --conf spark.ui.port=5089 \
  --queue root.gfctocon


import os

# Set the library path BEFORE importing shap
os.environ['LD_LIBRARY_PATH'] = '/data/1/gcganamrswp/data/is44065/data/modele_env_py39/lib:' + os.environ.get('LD_LIBRARY_PATH', '')

# Now import shap
import shap


======
python_wrapper.sh
=========
#!/bin/bash
export LD_LIBRARY_PATH=/data/1/gcganamrswp/data/is44065/data/modele_env_py39/lib:$LD_LIBRARY_PATH
exec /data/1/gcganamrswp/data/is44065/data/modele_env_py39/bin/python3 "$@"

chmod +x python_wrapper.sh

Then use it -- export PYSPARK_PYTHON=/path/to/python_wrapper.sh
export PYTHONPATH=/data/1/gcganamrswp/data/is44065/data/modele_env_py39/lib/python3.9/site-packages
