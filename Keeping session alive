.withColumn("prev_combined", lag("is_combined", 1).over(windowSpecLead))
.withColumn("can_combine", 
  when(condition = $"flag" === 1 && $"next_flag" === 1 && coalesce($"prev_combined", false) === false,
    size(split($"test_combined", "\\" + effectiveReplacementChar)) === schema.fields.length)
  .otherwise(false))
