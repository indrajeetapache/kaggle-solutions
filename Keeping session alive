.withColumn("is_combined", 
  when($"flag" === 1 && $"next_flag" === 1 && $"can_combine", true)
  .otherwise(false))
val combinedDfWithFlag = combinedDf
  .withColumn("is_invalid", 
    $"flag" === 1 && 
    ($"next_flag" === 0 || size(split($"combined_line", "\\" + effectiveReplacementChar)) =!= schema.fields.length)
  )
  .filter(
    $"flag" === 0 || 
    ($"flag" === 1 && $"is_combined" === true) ||
    ($"flag" === 1 && $"is_invalid" === true)
  )
